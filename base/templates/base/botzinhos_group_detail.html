{% extends "base/base.html" %}

{% load bootstrap5 mathfilters symbols %}

{% block title %}
	Botzinhos (Â∞èbots)
{% endblock title %}

{% block content %}
	<div class="container">
		<h6 class="text-center">
			<span id="date"></span> |
			<strong id="clock" class="text-primary"></strong>
			<strong>UTC</strong> - Time Interval: <span class="text-primary fw-bolder">| {{ time_interval }}m |</span>
		</h6>

		{% groups_breadcrumbs request.user %}

		<div class="container bg-warning bg-gradient">
			<h4 class="mt-1 mb-0 p-2">GROUP: {{ group.name|default:"(Sem Nome)" }}</h4>
		</div>

		<div id="bots-list" class="list-group">
			{% for bot in bots %}
			{% bot_render_html_snippet bot=bot %}
			{% endfor %}
		</div>

		{% if group.current_valuation and group.initial_valuation %}
		<div class="container mt-2 mb-0">
			<p><strong>Valuation</strong>: {{group.current_valuation|floatformat:3 }} {{ quote_asset }} [{% with group.current_valuation|div:group.initial_valuation|sub:1|mul:100 as var_val %}
			<span class="{% if var_val > 0 %}text-success{% else %}text-danger{% endif %}">{{ var_val|floatformat:3 }}%</span>]
		{% endwith %} <span class="text-muted">(Current)</span> | {{group.initial_valuation|floatformat:3 }} {{ quote_asset }} <span class="text-muted">(Initial)</span></p>
		</div>
		{% endif %}

		<div class="container mt-2 mb-0">
			<h4 class="mt-3">Actions</h4>
			<ul>
				<li>
					<a class="btn btn-warning" href="{% url "base:botzinhos-group-update" group.pk %}">Atualizar Grupo</a>
				</li>
				<li>
					<a class="btn btn-primary" href="{% url "base:botzinhos-create" %}?group={{group.pk}}">Novo Botzinho</a>
				</li>
				<li>
					{% url "base:botzinhos-group-action" group.pk "off" as action_url %}
					{% action_button action_url "Turn OFF" "btn-dark" %}
				</li>
				<li>
					{% url "base:botzinhos-group-action" group.pk "on" as action_url %}
					{% action_button action_url "Turn ON" "btn-primary" %}
				</li>
				<li>
					{% url "base:botzinhos-group-action" group.pk "liquidate" as action_url %}
					{% action_button action_url "LIQUIDATE (FORCE SELL and Turn OFF)" "btn-danger" %}
				</li>
			</ul>
		</div>
	</div>

	{% include "base/trades_section.html" with summary=summary trades=trades page_obj=page_obj %}

{% endblock content %}

{% block bootstrap5_extra_script %}
    <script>
    	if (location.protocol === "http:") {
    		ws_protocol = "ws:"
    	} else {
    		ws_protocol = "wss:"
    	}

        const botsSocket = new WebSocket(
            ws_protocol + '//'
            + window.location.host
            + '/ws/bots/html'
        );

        botsSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            // console.log(data)
            if (data.type === "bot_update") {
            	bot_element = document.getElementById(data.bot)
            	if (bot_element) {
            		bot_element.outerHTML = data.text;
            	}
            }
        };

        botsSocket.onclose = function(e) {
            console.error('Bots socket closed unexpectedly');
        };

        function currentTime() {
		  let date = new Date();
		  let hh = date.getUTCHours();
		  let mm = date.getUTCMinutes();
		  let ss = date.getUTCSeconds();

		   hh = (hh < 10) ? "0" + hh : hh;
		   mm = (mm < 10) ? "0" + mm : mm;
		   ss = (ss < 10) ? "0" + ss : ss;

		   let time = hh + ":" + mm + ":" + ss;

		  document.getElementById("clock").innerText = time;
		  document.getElementById("date").innerText = date.toLocaleDateString("en-US", {year: 'numeric', month: 'long', day: 'numeric' });
		  let t = setTimeout(function(){ currentTime() }, 1000);
		}

		currentTime();
    </script>
{% endblock %}
